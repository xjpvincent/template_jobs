/**
 * @module HavanaLoginModule
 *//**
 * window.MiniLoginEmbedder
 * @class window.MiniLoginEmbedder
 */(function(){if(window.MiniLoginEmbedder)return;window.MiniLoginEmbedder=function(){return this.config={targetId:"alibaba-login-iframe",iframeUrl:"https://passport.alipay.com/littleLogin/littleLogin.htm",appName:"4",appEntrance:"default",lang:"zh_CN",cssLink:"",styleType:"vertical",beforeSubmitBtnHtml:"",afterSubmitBtnHtml:"",bizParams:"",queryStr:"",resizeIframeWidthFix:!1,resizeIframeHeightFix:!1,loginId:null,iframeWidth:250,iframeHeight:250,notLoadSsoView:!1,notKeepLogin:!1},this.temp={target:null,iframe:null},this._listeners={},this._hashCodeCounter=0,this._messageType=null,this._bakWindowName=window.name,this._windowNameHash=null,this._windowNameTimer=null,this},window.MiniLoginEmbedder.prototype={merge:function(){var e={},t=Array.prototype.slice.call(arguments),n=0,r;while(r=t[n++])for(var i in r)e[i]=r[i];return e},json2str:function(e){switch(e.constructor){case Object:var t="{";for(var n in e){if(!e[n])continue;t+='"'+n+'":'+arguments.callee(e[n])+","}return t.substr(t.length-1)==","&&(t=t.substr(0,t.length-1)),t+"}";case Array:var t="[";for(var n in e)t+=arguments.callee(e[n])+",";return t.substr(t.length-1)==","&&(t=t.substr(0,t.length-1)),t+"]";default:return'"'+e.toString()+'"'}},str2json:function(e){return(new Function("return "+e))()},toQueryPair:function(e,t){return typeof t=="undefined"?e:e+"="+encodeURIComponent(t===null?"":String(t))},toQueryString:function(e){var t=this,n=[];for(var r in e){r=encodeURIComponent(r);var i=e[r];if(i&&i.constructor==Array){var s=[];for(var o=0,u=i.length,a;o<u;o++)a=i[o],s.push(t.toQueryPair(r,a));n=n.concat(s)}else n.push(t.toQueryPair(r,i))}return n.join("&")},get:function(e){return typeof e=="string"?document.getElementById(e):e},hasClass:function(e,t){return e.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))},addClass:function(e,t){if(e.className===""){e.className=t;return}this.hasClass(e,t)||(e.className+=" "+t)},removeClass:function(e,t){if(this.hasClass(e,t)){var n=new RegExp("(\\s|^)"+t+"(\\s|$)");e.className=e.className.replace(n," ")}},on:function(e,t,n){var r=this.get(e);r.attachEvent?(r["e"+t+n]=n,r[t+n]=function(){r["e"+t+n](window.event)},r.attachEvent("on"+t,r[t+n])):r.addEventListener(t,n,!1)},addEvent:function(e,t){if("function"!=typeof t)return;var n=this._listeners[e];n||(n=this._listeners[e]={}),n[this._toHashCode(t)]=t},fireEvent:function(e,t){if(!this._listeners[e])return;for(var n in this._listeners[e])this._listeners[e][n].call(this,t)},_toHashCode:function(e){return e._hashCode?e._hashCode:e._hashCode="_"+(this._hashCodeCounter++).toString(32)},_tempOnInit:function(){this.temp.target=this.get(this.config.targetId)},_parseWindowNameData:function(e){var t=e.split("[@]").pop().split("[login-iframe-message]");return{origin:t[0],data:t[1]}},init:function(e){this.config=this.merge(this.config,e||{});var t=this,n=this.config,r=this.temp;t._tempOnInit(),t._renderIframe(),window.postMessage?(t._messageType="postMessage",t.on(window,"message",function(e){t.messageHanlder.call(t,e)})):(t._messageType="windowName",window.name="",t._windowNameHash="",t._windowNameTimer=setInterval(function(){if(window.name===""||window.name.indexOf("[login-iframe-message]")===-1)return;window.name!=t._windowNameHash&&(t._windowNameHash=window.name,t.messageHanlder(t._parseWindowNameData(window.name)))},50)),t.on(window,"beforeunload",function(e){r.iframe.style.visibility="hidden"}),this.fireEvent("onInit",{_self:this}),this.free()},messageHanlder:function(e){var t=this,n=this.config,r=this.temp,i=t.str2json(decodeURIComponent(e.data));i.showIframe&&(r.iframe.style.visibility!=="visible"&&(r.iframe.style.visibility="visible"),this.fireEvent("onIframeShow",{_self:r.iframe}),t.addClass(r.target,"iframe-show")),i.hideIframe&&(r.iframe.style.visibility!=="hidden"&&(r.iframe.style.visibility="hidden"),this.fireEvent("onIframeHide",{_self:r.iframe}),t.removeClass(r.target,"iframe-show"));switch(i.action){case"resizeIframe":if(r.iframe.offsetHeight==0)return;n.resizeIframeWidthFix||(r.iframe.width=i.width),n.resizeIframeHeightFix||(r.iframe.height=i.height),t._bakOriginalIframeWidth||(n.resizeIframeWidthFix||(t._originalIframeWidth=i.width),n.resizeIframeHeightFix||(t._originalIframeHeight=i.height),t._bakOriginalIframeWidth=!0);break;case"otherAction":break;default:}this.fireEvent("onMessage",i)},restoreOriginalWidth:function(){this.iframe.width=this._originalIframeWidth},restoreOriginalHeight:function(){this.iframe.height=this._originalIframeHeight},_renderIframe:function(){var e=this,t=this.config,n=this.temp,r=n.target,i=this.temp.iframe=document.createElement("iframe"),s;s={lang:t.lang,appName:t.appName,appEntrance:t.appEntrance,cssLink:t.cssLink,styleType:t.styleType,bizParams:t.bizParams,notLoadSsoView:t.notLoadSsoView,notKeepLogin:t.notKeepLogin},t.loginId&&(s.loginId=t.loginId),i.id="alibaba-login-box",i.src=t.iframeUrl+"?"+e.toQueryString(s)+e.config.queryStr+"&rnd="+Math.random(),i.width=t.iframeWidth,i.height=t.iframeHeight,i.frameBorder="none",i.scrolling="no",i.style.border="none",e.on(i,"load",function(){e.addClass(r,"iframe-loaded")}),r.appendChild(i),this.fireEvent("afterRenderIframe",{iframe:i})},free:function(){/msie/i.test(navigator.userAgent)&&CollectGarbage()},sleep:function(){_self._messageType==="windowName"&&(clearInterval(_self._windowNameTimer),window.name=this._bakWindowName),this.free()},destory:function(){_self._messageType==="windowName"&&(clearInterval(_self._windowNameTimer),window.name=this._bakWindowName),this.free()}}})();